# 再文字起こし機能の拡張仕様

## 概要

現在の再文字起こし機能を拡張し、以下の2つの機能を追加する：

1. **波形ベースの境界調整**: 選択されたセグメントの前後に音声がある場合、自動的に開始・終了位置を調整
2. **隣接セグメントの自動選択**: 選択したセグメントに近い隣接セグメントを自動的に選択候補として提示

---

## 機能1: 波形ベースの境界調整

### 課題
- ASRのセグメント境界は必ずしも正確ではない
- セグメント開始前や終了後に実際の発話が含まれている場合がある
- 現状では手動で境界を調整する必要がある

### 解決策
波形データを分析し、セグメント境界の前後に音声活動（Voice Activity）がある場合、自動的に境界を拡張する。

### アルゴリズム

```
入力:
  - segment_start_time: セグメント開始時刻
  - segment_end_time: セグメント終了時刻
  - waveform_peaks: 波形ピークデータ (50 samples/sec)
  - THRESHOLD: 音声検出閾値 (デフォルト: 0.03)
  - SEARCH_WINDOW: 検索範囲 (デフォルト: 1000ms)
  - MERGE_GAP: この間隔以内の音声クラスタはマージ (デフォルト: 300ms)

処理:
  1. 音声クラスタの検出:
     - 検索範囲内で THRESHOLD 以上のピークを持つ区間を抽出
     - 連続するピーク群を「音声クラスタ」として認識

  2. 開始位置の調整 (前方検索):
     - segment_start_time から SEARCH_WINDOW 前まで検索
     - 音声クラスタを発見した場合:
       a. クラスタとセグメント間のギャップが MERGE_GAP 以内 → マージ
       b. さらに前のクラスタも MERGE_GAP 以内 → 連鎖的にマージ
     - 最も前のマージ対象クラスタの開始位置を新しい開始位置とする

  3. 終了位置の調整 (後方検索):
     - segment_end_time から SEARCH_WINDOW 後まで検索
     - 同様にクラスタをマージ
     - 最も後のマージ対象クラスタの終了位置を新しい終了位置とする

出力:
  - adjusted_start_time: 調整後の開始時刻
  - adjusted_end_time: 調整後の終了時刻
  - start_extended_ms: 開始位置の拡張量 (ms)
  - end_extended_ms: 終了位置の拡張量 (ms)
  - merged_clusters: マージされた音声クラスタの情報
```

### 例

```
時間軸:  14.0  14.5  15.0  15.5  16.0  16.5  17.0  17.5  18.0
波形:    ▓▓▓   ___   ▓▓    ___   |==セグメント==|   ▓▓▓
         ↑クラスタA   ↑クラスタB                    ↑クラスタC

セグメント: 16.0 - 17.5

判定:
- クラスタC (17.8-18.0): セグメント終了から300ms → マージ対象
- クラスタB (15.0-15.2): セグメント開始から800ms → マージ対象外（遠すぎ）
- クラスタA (14.0-14.3): 検索範囲内だがギャップ大 → マージ対象外

結果: 16.0 - 18.0 に拡張 (+500ms)
```

### パラメータ設定

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| THRESHOLD | 0.03 | この値以下を無音と判定（0-1スケール） |
| SEARCH_WINDOW | 1000ms | 境界から検索する最大範囲 |
| MERGE_GAP | 300ms | この間隔以内の音声クラスタをマージ |

### UI表示

再文字起こしモーダルに以下を追加：

```
┌──────────────────────────────────────────────────┐
│ 選択範囲: seg3 - seg5                             │
│                                                  │
│ [✓] 波形に基づいて境界を自動調整                  │
│     ┌─────────────────────────────────────────┐  │
│     │ 音声検出閾値:  [0.03 ▼] (0.01-0.10)     │  │
│     │ マージ間隔:    [300  ▼] ms (100-500)    │  │
│     │ 検索範囲:      [1000 ▼] ms (500-2000)   │  │
│     └─────────────────────────────────────────┘  │
│                                                  │
│ 時間範囲:                                         │
│   元:     16.200s ──────────────── 19.860s       │
│   調整後: 15.800s ──────────────── 20.400s       │
│           ↑ -400ms (クラスタ検出)   ↑ +540ms     │
│                                                  │
│ 検出した音声クラスタ:                             │
│   ▓▓ 15.80-16.00 (200ms) ← マージ               │
│   ▓▓▓▓▓▓ 16.20-19.86 (セグメント内)              │
│   ▓▓▓ 20.10-20.40 (300ms) ← マージ              │
│                                                  │
│ 波形プレビュー:                                   │
│   [▓▓][___][▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓][___][▓▓▓]         │
│    ↑マージ  |====選択範囲====|    マージ↑        │
└──────────────────────────────────────────────────┘
```

### パラメータUIの動作

- パラメータ変更時、リアルタイムで境界調整結果を再計算
- 波形プレビューも動的に更新

---

## 機能2: 隣接セグメントの自動選択

### 課題
- 発話が複数セグメントにまたがっている場合、個別に再文字起こしすると不自然になる
- 近接したセグメントは一緒に処理した方が認識精度が向上する

### 解決策
セグメント選択時に、下部バーで隣接セグメントを候補として表示し、ダイアログを開く前に選択範囲を調整できるようにする。

※ 機能1（波形ベースの境界調整）はダイアログ内で行う。機能2はダイアログ表示前のセグメント選択にフォーカスすることで、役割を明確に分離する。

### アルゴリズム

```
入力:
  - selected_segments: ユーザーが選択したセグメントのインデックス
  - all_segments: 全セグメントデータ
  - PROXIMITY_THRESHOLD: 近接判定閾値 (デフォルト: 500ms)

処理:
  1. 選択範囲の境界を特定:
     - first_selected = min(selected_segments)
     - last_selected = max(selected_segments)

  2. 前方の近接セグメントを検索:
     - prev_segment = all_segments[first_selected - 1]
     - gap = first_segment.start_time - prev_segment.end_time
     - if gap <= PROXIMITY_THRESHOLD: 候補として追加

  3. 後方の近接セグメントを検索:
     - next_segment = all_segments[last_selected + 1]
     - gap = next_segment.start_time - last_segment.end_time
     - if gap <= PROXIMITY_THRESHOLD: 候補として追加

出力:
  - suggested_segments: 自動選択候補のインデックス配列
  - gaps: 各候補とのギャップ時間 (ms)
```

### パラメータ設定

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| PROXIMITY_THRESHOLD | 500ms | この時間以内の隣接セグメントを候補とする |
| MAX_AUTO_EXTEND | 2 | 前後それぞれ最大何セグメントまで候補に含めるか |

### UI表示

下部バー（セグメント選択時に表示）で隣接セグメント候補を表示：

```
┌─────────────────────────────────────────────────────────────────┐
│ 選択中: seg3-seg5                                               │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ [✓] seg2 (80ms前)  │ [選択範囲] │ [ ] seg6 (200ms後)        │ │
│ │     "前の..."      │            │     "次の..."             │ │
│ └─────────────────────────────────────────────────────────────┘ │
│ [クリア]                                      [再文字起こし]    │
└─────────────────────────────────────────────────────────────────┘
```

※ モデル・Tempoセレクタは下部バーから削除（モーダル内で設定）

### 自動選択のルール

1. **ギャップが200ms未満**: 自動的にチェックON（ほぼ連続した発話）
2. **ギャップが200-500ms**: チェックOFFで候補表示（ユーザー判断）
3. **ギャップが500ms超**: 候補として表示しない

---

## API変更

### リクエスト拡張

```json
POST /api/audio/:source_id/retranscribe

{
  "segment_start": 2,
  "segment_end": 4,
  "tempo": 0.95,
  "model": "reazonspeech",
  "preview": true,

  // 新規フィールド
  "auto_adjust_boundary": true,
  "boundary_threshold": 0.03,
  "boundary_search_window_ms": 500,

  "include_adjacent": [1, 5],  // 隣接セグメントを含める
}
```

### レスポンス拡張

```json
{
  "success": true,
  "original_segments": [...],
  "new_segments": [...],

  // 新規フィールド
  "boundary_adjustment": {
    "original_start": 16.200,
    "original_end": 19.860,
    "adjusted_start": 16.050,
    "adjusted_end": 20.100,
    "start_extended_ms": -150,
    "end_extended_ms": 240
  },

  "adjacent_suggestions": [
    {
      "index": 1,
      "gap_ms": 120,
      "direction": "before",
      "text": "...前のテキスト",
      "auto_selected": false
    },
    {
      "index": 5,
      "gap_ms": 80,
      "direction": "after",
      "text": "次のテキスト...",
      "auto_selected": true
    }
  ]
}
```

---

## 実装計画

### Phase 1: 波形ベースの境界調整
1. `internal/asr/boundary.go` - 境界調整ロジック実装
2. `internal/handlers/audio.go` - Retranscribe APIの拡張
3. フロントエンドのモーダルUI更新

### Phase 2: 隣接セグメントの自動選択
1. 隣接セグメント検出ロジック追加
2. フロントエンドの選択UI更新
3. 自動選択ルールの実装

---

## 検討事項

### 波形閾値の調整
- 環境音やノイズレベルによって最適な閾値が異なる
- 将来的にはノイズフロアを自動検出して閾値を動的調整

### 過度な拡張の防止
- 隣接セグメントとの境界を越えない制限
- 最大拡張時間の上限設定（例: 1秒）

### パフォーマンス
- 波形データは既にキャッシュされているため追加のAPIコールは不要
- フロントエンドで境界調整の計算を行う（サーバー負荷軽減）
