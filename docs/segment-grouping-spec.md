# セグメントグループ化機能の仕様

## 概要

セグメント間のギャップに基づいて、隣接するセグメントを事前にグループ化する。
グループ化が有効な場合、1つのセグメントをクリックすると同一グループ内の全セグメントが同時に選択される。

---

## 現状の問題点

現在の「隣接セグメント候補表示」方式:
1. セグメントを選択
2. 下部バーに隣接候補が表示される
3. チェックボックスで含めるか選択
4. 再文字起こしボタンを押す

**問題:**
- 操作ステップが多い
- 事前にグループが見えないため、どこまでが一連の発話か分かりにくい
- 毎回チェックボックスを確認する必要がある

---

## 新しい方式: 事前グループ化

### 動作フロー

1. ヘッダの「隣接セグメントをグループ化」をON
2. 画面上でセグメントがグループごとに視覚的に区切られる
3. グループ内の任意のセグメントをクリック → グループ全体が選択される
4. 下部バーで「再文字起こし」ボタンを押す

### グループ化アルゴリズム

```
入力:
  - segments: 全セグメント配列
  - GAP_THRESHOLD: グループ化閾値 (ms)

処理:
  groups = []
  currentGroup = [segments[0]]

  for i = 1 to segments.length - 1:
    gap = segments[i].start - segments[i-1].end
    if gap <= GAP_THRESHOLD:
      currentGroup.push(segments[i])
    else:
      groups.push(currentGroup)
      currentGroup = [segments[i]]

  groups.push(currentGroup)

出力:
  - groups: セグメントグループの配列
```

---

## UI設計

### ヘッダ部分（トランスクリプト上部）

```
┌────────────────────────────────────────────────────────────────────────┐
│ [トランスクリプト]                                      [JSONを見る]   │
├────────────────────────────────────────────────────────────────────────┤
│ [✓] 隣接セグメントをグループ化  │  閾値: [500ms ▼]  │  グループ数: 12  │
└────────────────────────────────────────────────────────────────────────┘
```

**要素:**
- チェックボックス: 「隣接セグメントをグループ化」
- セレクト: グループ化閾値（200ms, 300ms, 500ms, 750ms, 1秒, 1.5秒, 2秒, 3秒, 5秒）
- 表示: グループ数（閾値変更時にリアルタイム更新）

### セグメント表示の変更

**グループ化OFF時（現状と同じ）:**
```
│ seg1 │ seg2 │ seg3 │ seg4 │ seg5 │ seg6 │ seg7 │
```

**グループ化ON時:**
```
│ seg1 │ seg2 │ seg3 ││ seg4 │ seg5 ││ seg6 ││ seg7 │
      └─ Group 1 ─┘   └─ Group 2 ─┘  └ G3 ┘  └ G4 ┘
```

視覚的な区切り:
- グループ間: 太めのボーダー or 余白
- 同一グループ内: 薄い背景色でまとめる（ホバー時にグループ全体がハイライト）

### 選択時の動作

**グループ化OFF時:**
- クリック: そのセグメントのみ選択
- Shift+クリック: 範囲選択

**グループ化ON時:**
- クリック: グループ全体を選択
- Shift+クリック: グループ単位での範囲選択

### 下部バー（選択時）

```
┌─────────────────────────────────────────────────────────────────┐
│ 選択中: seg4-seg5 (グループ2)                     [再文字起こし] │
│ 1.2s - 3.4s (2.2秒)                                   [クリア]  │
└─────────────────────────────────────────────────────────────────┘
```

- 隣接候補の表示は不要（グループ化で解決済み）
- シンプルに選択情報と再文字起こしボタンのみ

---

## 削除する機能

以下の機能は不要になるため削除:

1. 下部バーの隣接セグメント候補表示
   - prev-segment-candidate
   - next-segment-candidate
   - チェーンされたセグメント検出ロジック

2. 隣接セグメント用の設定パネル（下部バー内）
   - adjacent-settings-toggle
   - adjacent-settings-panel
   - proximity-threshold（ヘッダに移動）
   - auto-select-threshold（不要になる）

---

## 実装計画

### Phase 1: ヘッダUI追加
1. グループ化チェックボックス追加
2. 閾値セレクト追加
3. グループ数表示追加

### Phase 2: グループ化ロジック
1. セグメントをグループ化する関数実装
2. 閾値変更時のリアルタイム再計算
3. グループ情報をセグメント要素に付与（data-group-id）

### Phase 3: 視覚的表示
1. グループ間の区切り表示
2. 同一グループのホバーハイライト
3. グループ選択時のハイライト

### Phase 4: 選択動作
1. グループクリックで全体選択
2. 下部バーのシンプル化
3. 不要な隣接候補機能の削除

---

## 設定の永続化

- グループ化ON/OFF: LocalStorageに保存
- 閾値: LocalStorageに保存
- ページ再読み込み時に復元

---

## 検討事項

### グループが大きすぎる場合
- 閾値が大きいと、多数のセグメントが1グループになる可能性
- グループ内セグメント数の上限は設けない（ユーザーが閾値で調整）

### 個別セグメント選択の必要性
- グループ化ON時でも、Ctrl+クリックで個別選択できるようにする？
- または、グループ化を一時的にOFFにして選択？
- → まずはシンプルに、グループ化ON時はグループ単位選択のみとする

### 波形境界調整との連携
- グループ選択後のモーダルで、波形境界調整は引き続き使用可能
- グループの開始/終了境界を波形ベースで微調整
